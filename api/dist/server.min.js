"use strict";var express=require("express"),mongoose=require("mongoose"),Ably=require("ably"),cors=require("cors");require("dotenv").config();var app=express(),port=process.env.PORT||3e3;mongoose.connect(process.env.MONGO_URI,{useNewUrlParser:!0,useUnifiedTopology:!0}).then(function(){return console.log("MongoDB connected")}).catch(function(e){return console.log("MongoDB connection error:",e)});var Message=require("./message");app.use(express.json()),app.use(cors());var ably=new Ably.Realtime({key:process.env.ABLY_API_KEY}),publicChannel=ably.channels.get("chat");publicChannel.subscribe("message",function(r){var s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=new Message({text:r.data.text}),e.prev=1,e.next=4,regeneratorRuntime.awrap(s.save());case 4:console.log("Message saved to DB:",r.data.text),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(1),console.error("Error saving message to DB:",e.t0);case 10:case"end":return e.stop()}},null,null,[[1,7]])}),app.get("/messages",function(e,r){var s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Message.find().sort({timestamp:-1}));case 3:s=e.sent,console.log("Fetched messages from DB:",s),r.json(s),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(0),console.error("Error fetching messages:",e.t0),r.status(500).json({error:"Failed to fetch messages"});case 12:case"end":return e.stop()}},null,null,[[0,8]])}),app.post("/messages",function(r,s){var t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.body.text){e.next=3;break}return e.abrupt("return",s.status(400).json({error:"Message text is required"}));case 3:return n=new Message({text:t}),e.prev=4,e.next=7,regeneratorRuntime.awrap(n.save());case 7:console.log("Message saved to DB:",t),s.status(201).json(n),e.next=15;break;case 11:e.prev=11,e.t0=e.catch(4),console.error("Error saving message to DB:",e.t0),s.status(500).json({error:"Failed to save message"});case 15:case"end":return e.stop()}},null,null,[[4,11]])}),app.use(express.static("public")),module.exports=app;
//# sourceMappingURL=server.min.js.map
